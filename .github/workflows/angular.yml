name: Angular

on:
  workflow_call:

jobs:
  build:
    name: ⚒️
    uses: ./.github/workflows/angular.build.yml
    with:
      out_dir: dist/${{ github.event.repository.name }}

  test:
    name: 🧪
    needs: [build]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    uses: ./.github/workflows/angular.test.yml

  lint:
    name: 🧹
    needs: [build]
    uses: ./.github/workflows/angular.lint.yml

  pages:
    name: 🚀
    if: github.ref == 'refs/heads/main'
    needs: [build, test, lint]
    uses: ./.github/workflows/angular.pages.deploy.yml

  docker:
    name: 🐳
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
    needs: [build, test, lint]
    uses: ./.github/workflows/angular.docker.yml
    secrets: inherit

  terraform:
    name: 🟣
    needs: [build, test, lint]
    uses: ./.github/workflows/angular.terraform.yml
    secrets: inherit

  terraform-deploy:
    needs: [terraform]
    runs-on: ubuntu-latest
    # uses: ./.github/workflows/angular.terraform.deploy.yml
    # secrets: inherit
    steps:
      - run: echo ${{ needs.terraform.outputs.name }}
      - run: echo ${{ needs.terraform.outputs.url }}
      - uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.artifact-name }}
      - uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_CLIENT_SECRET }}
          action: upload
          app_location: /dist
          skip_app_build: true

  release:
    name: 🚢
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build, test, lint]
    uses: ./.github/workflows/angular.release.yml
